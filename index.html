<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>器材借出申請</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 設定字體為 Inter，並提供 fallback */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* 淺灰色背景 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* 確保頁面至少佔滿整個視窗高度 */
            padding: 1rem; /* 增加一些內邊距 */
        }
        /* 自定義滾動條樣式 */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #555;
            border-radius: 10px;
        }
        /* 可點擊項目的基本樣式 */
        .clickable-item {
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }
        /* 選中項目的樣式 */
        .clickable-item.selected {
            background-color: #bfdbfe; /* blue-200 */
            border-color: #60a5fa; /* blue-400 */
        }
        .clickable-item:hover {
            background-color: #e0e7ff; /* indigo-100 */
        }
        .message-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .message-info {
            background-color: #e0e7ff;
            color: #3730a3;
        }
    </style>
</head>
<body>
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md md:max-w-xl lg:max-w-2xl xl:max-w-3xl">
        <!-- 頁面標題 -->
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">器材借出申請</h1>

        <!-- 借出表單 -->
        <form id="borrowForm" class="space-y-6">
            <!-- 借出人區塊 -->
            <div>
                <label for="borrowerName" class="block text-sm font-medium text-gray-700 mb-1">借出人姓名</label>
                <input type="text" id="borrowerName" name="borrowerName" placeholder="請輸入您的姓名"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                       required>
            </div>

            <!-- 新增：借用單位區塊 -->
            <div>
                <label for="borrowingUnit" class="block text-sm font-medium text-gray-700 mb-1">借用單位</label>
                <input type="text" id="borrowingUnit" name="borrowingUnit" placeholder="請輸入借用單位或部門"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                       required>
            </div>

            <!-- 新增：聯絡方式區塊 -->
            <div>
                <label for="contactInfo" class="block text-sm font-medium text-gray-700 mb-1">聯絡方式</label>
                <input type="text" id="contactInfo" name="contactInfo" placeholder="請輸入電話或電子郵件"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                       required>
            </div>

            <!-- 器材選擇區塊 (左右兩欄與中央按鈕) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">選擇器材 (點擊項目選取)</label>
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- 左側：可用器材清單 -->
                    <div class="flex-1 bg-gray-50 p-4 rounded-md border border-gray-200 shadow-sm">
                        <h2 class="text-lg font-semibold text-gray-700 mb-4">可用器材</h2>
                        <div id="availableEquipmentList" class="space-y-2 max-h-60 overflow-y-auto border border-gray-300 rounded-md p-2">
                            <!-- 器材將在這裡動態載入 -->
                            <p class="text-gray-500 text-center py-4">載入中...</p>
                        </div>
                    </div>

                    <!-- 中間：操作按鈕 -->
                    <div class="flex flex-col justify-center items-center gap-4 py-4 md:py-0">
                        <button type="button" id="addSelectedBtn" class="px-2 py-1 text-xs bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                            加入 &gt;&gt;
                        </button>
                        <button type="button" id="removeSelectedBtn" class="px-2 py-1 text-xs bg-red-600 text-white font-medium rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                            &lt;&lt; 移除
                        </button>
                    </div>

                    <!-- 右側：已選器材清單 -->
                    <div class="flex-1 bg-gray-50 p-4 rounded-md border border-gray-200 shadow-sm">
                        <h2 class="text-lg font-semibold text-gray-700 mb-4">已選器材</h2>
                        <div id="selectedEquipmentList" class="space-y-2 max-h-60 overflow-y-auto border border-gray-300 rounded-md p-2">
                            <!-- 已選器材將在這裡顯示 -->
                            <p class="text-gray-500 text-center py-4">尚未選擇器材</p>
                        </div>
                    </div>
                </div>
                <!-- 隱藏的 input 欄位，用於儲存選中的器材清單，方便表單提交 -->
                <input type="hidden" id="selectedEquipmentInput" name="selectedEquipment">
            </div>

            <!-- 借出時間區塊 -->
            <div>
                <label for="borrowTime" class="block text-sm font-medium text-gray-700 mb-1">借出時間</label>
                <input type="datetime-local" id="borrowTime" name="borrowTime"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                       required>
            </div>

            <!-- 提交按鈕 -->
            <button type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                送出申請
            </button>
        </form>

        <!-- 訊息顯示區塊 (用於顯示提交成功或錯誤訊息) -->
        <div id="messageBox" class="mt-6 p-4 rounded-md hidden"></div>
    </div>

    <script>
        // JavaScript 程式碼
        document.addEventListener('DOMContentLoaded', function() {
            const borrowTimeInput = document.getElementById('borrowTime');
            const borrowForm = document.getElementById('borrowForm');
            const messageBox = document.getElementById('messageBox');
            const availableEquipmentList = document.getElementById('availableEquipmentList');
            const selectedEquipmentList = document.getElementById('selectedEquipmentList');
            const addSelectedBtn = document.getElementById('addSelectedBtn');
            const removeSelectedBtn = document.getElementById('removeSelectedBtn');

            // !!! IMPORTANT: 請將 'YOUR_BASEROW_API_KEY' 替換為您的實際 Baserow API 金鑰 !!!
            const baserowApiKey = '29E0NGXsq1rXu9p8fW0rPj6CRnu6mg38'; 

            let allAvailableEquipments = []; // 儲存所有從資料來源載入的器材 (包含 ID)
            let currentSelectedEquipments = []; // 儲存目前已選的器材 (包含 ID)
            let selectedAvailableItems = new Set(); // 儲存可用清單中被選中的項目 (使用 eqp_no)
            let selectedSelectedItems = new Set(); // 儲存已選清單中被選中的項目 (使用 eqp_no)

            // 取得當前日期時間並設定為預設值
            function getCurrentDateTimeLocal() {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // 調整時區偏移
                return now.toISOString().slice(0, 16); // 格式化為 YYYY-MM-DDTHH:MM
            }

            // 設定借出時間的預設值為當前時間
            borrowTimeInput.value = getCurrentDateTimeLocal();

            // 渲染器材清單 (左右兩欄)
            function renderEquipmentLists() {
                // 渲染可用器材清單
                availableEquipmentList.innerHTML = ''; // 清空
                const availableToDisplay = allAvailableEquipments.filter(eq => !currentSelectedEquipments.some(selEq => selEq.id === eq.id));
                if (availableToDisplay.length > 0) {
                    availableToDisplay.forEach(equipment => {
                        const div = document.createElement('div');
                        // 檢查是否被選中，添加 'selected' class
                        const isSelected = selectedAvailableItems.has(equipment.eqp_no) ? ' selected' : '';
                        div.className = `clickable-item p-2 bg-white rounded-md border border-gray-200 text-sm${isSelected}`;
                        div.dataset.equipmentId = equipment.id;
                        div.dataset.equipmentNo = equipment.eqp_no;
                        div.textContent = equipment.eqp_no;
                        availableEquipmentList.appendChild(div);
                    });
                } else {
                    availableEquipmentList.innerHTML = '<p class="text-gray-500 text-center py-4">無可用器材</p>';
                }

                // 渲染已選器材清單
                selectedEquipmentList.innerHTML = ''; // 清空
                if (currentSelectedEquipments.length > 0) {
                    currentSelectedEquipments.forEach(equipment => {
                        const div = document.createElement('div');
                        // 檢查是否被選中，添加 'selected' class
                        const isSelected = selectedSelectedItems.has(equipment.eqp_no) ? ' selected' : '';
                        div.className = `clickable-item p-2 bg-white rounded-md border border-gray-200${isSelected}`;
                        div.dataset.equipmentId = equipment.id;
                        div.dataset.equipmentNo = equipment.eqp_no;
                        div.textContent = equipment.eqp_no;
                        selectedEquipmentList.appendChild(div);
                    });
                } else {
                    selectedEquipmentList.innerHTML = '<p class="text-gray-500 text-center py-4">尚未選擇器材</p>';
                }
            }

            // 從 Baserow API 載入器材清單 (GET 請求)
            async function loadEquipmentList() {
                availableEquipmentList.innerHTML = '<p class="text-gray-500 text-center py-4">載入中...</p>';
                selectedEquipmentList.innerHTML = '<p class="text-gray-500 text-center py-4">載入中...</p>'; // 確保已選清單也顯示載入中

                // Baserow API URL 用於獲取可用器材清單 (table/622062)
                // 新增 filter__status__equal=在庫 參數來篩選狀態為「在庫」的器材
                const baserowApiGetUrl = 'https://api.baserow.io/api/database/rows/table/622062/?user_field_names=true&filter__status__equal=在庫'; 
                
                try {
                    const response = await fetch(baserowApiGetUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Token ${baserowApiKey}`, // 添加 Authorization 標頭
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`HTTP Error during fetch: ${response.status} ${response.statusText}`, errorText);
                        throw new Error(`HTTP 錯誤! 狀態: ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json(); // 解析 JSON 回應

                    if (data.error) {
                        showMessage(`載入器材清單失敗: ${data.error}`, 'error');
                        availableEquipmentList.innerHTML = '<p class="text-red-500 text-center py-4">載入失敗</p>';
                        return;
                    }

                    // 從 Baserow API 的 results 陣列中提取器材名稱與 row_id
                    allAvailableEquipments = data.results.map(item => ({ id: item.id, eqp_no: item.eqp_no })); 
                    renderEquipmentLists(); // 初始渲染
                } catch (error) {
                    console.error('載入器材清單時發生錯誤:', error);
                    let errorMessage = '未知錯誤';
                    if (error instanceof TypeError && error.message === 'Failed to fetch') {
                        errorMessage = '網路連線問題或 Baserow 服務無法存取。請檢查您的網路連線是否正常，或確認 Baserow API 可公開存取。';
                    } else {
                        errorMessage = error.message;
                    }
                    showMessage(`載入器材清單失敗: ${errorMessage}`, 'error');
                    availableEquipmentList.innerHTML = `<p class="text-red-500 text-center py-4">載入失敗: ${errorMessage}</p>`;
                }
            }

            // 頁面載入時載入器材清單
            loadEquipmentList();

            // 處理可用器材列表的點擊事件 (選取/取消選取)
            availableEquipmentList.addEventListener('click', function(event) {
                const clickedItem = event.target.closest('.clickable-item');
                if (clickedItem && clickedItem.dataset.equipmentNo) {
                    const equipmentNo = clickedItem.dataset.equipmentNo;
                    if (selectedAvailableItems.has(equipmentNo)) {
                        selectedAvailableItems.delete(equipmentNo);
                    } else {
                        selectedAvailableItems.add(equipmentNo);
                    }
                    renderEquipmentLists(); // 重新渲染以更新選取狀態
                }
            });

            // 處理已選器材列表的點擊事件 (選取/取消選取)
            selectedEquipmentList.addEventListener('click', function(event) {
                const clickedItem = event.target.closest('.clickable-item');
                if (clickedItem && clickedItem.dataset.equipmentNo) {
                    const equipmentNo = clickedItem.dataset.equipmentNo;
                    if (selectedSelectedItems.has(equipmentNo)) {
                        selectedSelectedItems.delete(equipmentNo);
                    } else {
                        selectedSelectedItems.add(equipmentNo);
                    }
                    renderEquipmentLists(); // 重新渲染以更新選取狀態
                }
            });

            // 處理「加入」按鈕點擊事件
            addSelectedBtn.addEventListener('click', function() {
                if (selectedAvailableItems.size === 0) {
                    showMessage('請先在左側選擇要加入的器材！', 'error');
                    return;
                }
                selectedAvailableItems.forEach(equipmentNo => {
                    const equipment = allAvailableEquipments.find(eq => eq.eqp_no === equipmentNo);
                    if (equipment && !currentSelectedEquipments.some(selEq => selEq.id === equipment.id)) {
                        currentSelectedEquipments.push(equipment);
                    }
                });
                selectedAvailableItems.clear(); // 清空已選中的可用項目
                renderEquipmentLists(); // 重新渲染
                showMessage('器材已加入已選清單！', 'success');
            });

            // 處理「移除」按鈕點擊事件
            removeSelectedBtn.addEventListener('click', function() {
                if (selectedSelectedItems.size === 0) {
                    showMessage('請先在右側選擇要移除的器材！', 'error');
                    return;
                }
                const equipmentsToRemove = Array.from(selectedSelectedItems);
                currentSelectedEquipments = currentSelectedEquipments.filter(eq => !equipmentsToRemove.includes(eq.eqp_no));
                selectedSelectedItems.clear(); // 清空已選中的已選項目
                renderEquipmentLists(); // 重新渲染
                showMessage('器材已從已選清單移除！', 'success');
            });


            // 表單提交處理
            borrowForm.addEventListener('submit', async function(event) {
                event.preventDefault(); // 阻止表單預設提交行為

                const borrowerName = document.getElementById('borrowerName').value;
                // 新增：取得借用單位與聯絡方式的值
                const borrowingUnit = document.getElementById('borrowingUnit').value;
                const contactInfo = document.getElementById('contactInfo').value;
                const borrowTime = document.getElementById('borrowTime').value;

                if (currentSelectedEquipments.length === 0) {
                    showMessage('請至少選擇一項器材！', 'error');
                    return;
                }

                showMessage('送出申請中...', 'info'); // 顯示載入訊息

                const baserowUpdateUrl = 'https://api.baserow.io/api/database/rows/table/622062/';
                const successfulUpdates = [];
                const failedUpdates = [];

                for (const equipment of currentSelectedEquipments) {
                    // 修正：將 borrowTime 轉換為 YYYY-MM-DD 格式
                    const borrowDate = borrowTime.split('T')[0];

                    // 新增：在 patchData 中加入借用單位與聯絡方式
                    const patchData = {
                        'status': '借用',
                        'borrower': borrowerName,
                        'borrow_dept': borrowingUnit,
                        'contact': contactInfo,
                        'borrow_date': borrowDate, // 使用修正後的 borrowDate
                    };

                    try {
                        const response = await fetch(`${baserowUpdateUrl}${equipment.id}/?user_field_names=true`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Token ${baserowApiKey}`
                            },
                            body: JSON.stringify(patchData),
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error(`Failed to update equipment ID ${equipment.id}:`, errorData);
                            failedUpdates.push(`器材 ${equipment.eqp_no} (更新失敗: ${errorData.detail || JSON.stringify(errorData)})`);
                        } else {
                            successfulUpdates.push(`器材 ${equipment.eqp_no}`);
                        }
                    } catch (error) {
                        console.error('提交申請時發生錯誤:', error);
                        failedUpdates.push(`器材 ${equipment.eqp_no} (更新失敗: 網路連線錯誤或 API 無法存取)`);
                    }
                }

                // 顯示總結訊息
                const messages = [];
                if (successfulUpdates.length > 0) {
                    messages.push(`✅ 成功借出 ${successfulUpdates.length} 項器材：`);
                    messages.push(...successfulUpdates.map(msg => `- ${msg}`));
                }
                if (failedUpdates.length > 0) {
                    messages.push(`❌ 更新失敗 ${failedUpdates.length} 項器材：`);
                    messages.push(...failedUpdates.map(msg => `- ${msg}`));
                }

                if (failedUpdates.length === 0) {
                    showMessage(messages.join('<br>'), 'success');
                } else {
                    showMessage(messages.join('<br>'), 'error');
                }

                // 成功後清空表單並重新載入可用器材清單
                borrowForm.reset();
                currentSelectedEquipments = [];
                selectedAvailableItems.clear();
                selectedSelectedItems.clear();
                loadEquipmentList(); // 重新載入，以反映狀態已變更的器材
                borrowTimeInput.value = getCurrentDateTimeLocal(); // 重設借出時間
            });

            // 顯示訊息的函數，支援 HTML 內容
            function showMessage(message, type) {
                messageBox.innerHTML = message;
                messageBox.classList.remove('hidden', 'message-success', 'message-error', 'message-info');
                if (type === 'success') {
                    messageBox.classList.add('message-success');
                } else if (type === 'error') {
                    messageBox.classList.add('message-error');
                } else if (type === 'info') {
                    messageBox.classList.add('message-info');
                }
                messageBox.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
